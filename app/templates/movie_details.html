{% extends "layout.html" %}

{% block content %}
<div class="movie-details">
    <div class="movie-details-content">
        <div class="movie-poster-large">
            <img src="{{ movie.poster }}" alt="{{ movie.title }}">
        </div>
        
        <div class="movie-info-large">
            <h2>{{ movie.title }} <span class="year">({{ movie.year }})</span></h2>
            <p class="director">Director: {{ movie.director }}</p>
            <p class="genre">Género: {{ movie.genre }}</p>
            <div class="description">
                <h3>Sinopsis</h3>
                <p>{{ movie.description }}</p>
            </div>
            
            <div class="rental-section">
                <p class="price">Precio de renta: ${{ movie.price }}</p>
                
                {% if is_rented %}
                <button class="btn-secondary" disabled aria-disabled="true">Ya Rentada</button>
                {% else %}
                <button id="rent-button" class="btn-primary">Rentar Película</button>
                <p id="rent-message" class="success-message"></p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    {% if not is_rented %}
    document.getElementById('rent-button').addEventListener('click', function() {
        fetch('/rent/{{ movie.id }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error en la respuesta del servidor');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                document.getElementById('rent-message').textContent = '¡Película rentada con éxito!';
                document.getElementById('rent-button').disabled = true;
                document.getElementById('rent-button').classList.remove('btn-primary');
                document.getElementById('rent-button').classList.add('btn-secondary');
                document.getElementById('rent-button').textContent = 'Ya Rentada';
                
                // Redirigir a mis rentas después de un breve retraso
                setTimeout(() => {
                    window.location.href = '/my-rentals';
                }, 1500);
            } else {
                document.getElementById('rent-message').textContent = data.message;
                document.getElementById('rent-message').classList.remove('success-message');
                document.getElementById('rent-message').classList.add('error-message');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('rent-message').textContent = 'Error al procesar la solicitud';
            document.getElementById('rent-message').classList.remove('success-message');
            document.getElementById('rent-message').classList.add('error-message');
        });
    });
    {% endif %}
</script>
{% endblock %}